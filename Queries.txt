-- Query 1

SELECT a.Name artist,
       COUNT(t.Name) num_tracks,
       SUM(i.Total) sum_total
FROM Artist a
JOIN Album ON Album.ArtistId = a.ArtistId
JOIN Track t ON t.AlbumId = Album.AlbumId
JOIN PlaylistTrack pt ON t.TrackId = pt.TrackId
JOIN Playlist p ON p.PlaylistId = pt.PlaylistId
JOIN InvoiceLine l ON t.TrackId = l.TrackId
JOIN Invoice i ON i.InvoiceId = l.InvoiceId
AND p.Name = '90’s Music'
GROUP BY 1
ORDER BY 3 DESC
LIMIT 5;

---------------------------------------------------------------------------------
-- Query 2

SELECT g.Name Genre,
       STRFTIME('%Y', i.InvoiceDate) YEAR,
                                     SUM(i.Total) sum_total
FROM Genre g
JOIN Track t ON g.GenreId = t.GenreId
JOIN InvoiceLine l ON l.TrackId = t.TrackId
JOIN Invoice i ON i.InvoiceId = l.InvoiceId
AND Genre = 'Jazz'
GROUP BY 1,
         2
ORDER BY 2;

---------------------------------------------------------------------------------
--Query 3
WITH t1 AS
  (SELECT g.Name,
          COUNT(t.TrackId) num_of_tracks
   FROM Genre g
   JOIN Track t ON t.GenreId = g.GenreId
   GROUP BY 1
   ORDER BY 2 DESC)
SELECT CASE
           WHEN t1.num_of_tracks >
                  (SELECT AVG(num_of_tracks) avg_tracks
                   FROM t1) THEN Name
           ELSE 'Other'
       END AS Genre_categories,
       SUM(t1.num_of_tracks) number_of_tracks
FROM t1
GROUP BY 1
ORDER BY 2 DESC;

---------------------------------------------------------------------------------
-- Query 4
WITH t1 AS
  (SELECT c.Country,
          SUM(i.Total) total_purchases
   FROM Customer c
   JOIN Invoice i ON i.CustomerId = c.CustomerId
   GROUP BY 1
   ORDER BY 2 DESC
   LIMIT 1),
     t2 AS
  (SELECT a.Name artist,
          COUNT(t.Name) num_tracks,
          SUM(i.Total) sum_total
   FROM Artist a
   JOIN Album ON Album.ArtistId = a.ArtistId
   JOIN Track t ON t.AlbumId = Album.AlbumId
   JOIN PlaylistTrack pt ON t.TrackId = pt.TrackId
   JOIN Playlist p ON p.PlaylistId = pt.PlaylistId
   JOIN InvoiceLine l ON t.TrackId = l.TrackId
   JOIN Invoice i ON i.InvoiceId = l.InvoiceId
   AND p.Name = '90’s Music'
   GROUP BY 1
   ORDER BY 3 DESC
   LIMIT 5)
SELECT c.Country,
       a.Name artist,
       SUM(i.Total) total_puchases,
       COUNT(t.TrackId) num_of_tracks
FROM Customer c
JOIN Invoice i ON i.CustomerId = c.CustomerId
JOIN InvoiceLine l ON l.InvoiceId = i.InvoiceId
JOIN Track t ON t.TrackId = l.TrackId
JOIN Album al ON al.AlbumId = t.AlbumId
JOIN Artist a ON a.ArtistId = al.ArtistId
AND c.Country =
  (SELECT Country
   FROM t1)
AND a.Name NOT IN
  (SELECT artist
   FROM t2)
GROUP BY 1,
         2
ORDER BY 3 DESC
LIMIT 5;